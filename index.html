<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>debates legislativas 2024</title>
        <style>
            body {
                font-family: sans-serif;
            }

            button {
                display: inline-block;
                margin-left: 10px;
            }

            li span {
                display: inline-block;
                width: 120px;
            }

            #progress {
                width: 600px;
            }

            #content {
                background-color: aliceblue;
                max-height: 60vh;
                overflow-y: scroll;
            }

            .highlight {
                background-color: yellow;
            }
        </style>
    </head>
    <body>
        <ul>
            <li>5 fev (2a)</li>
            <ul>
                <li><span>PAN - CHEGA</span><button onclick="run('2024-02-05_pan-chega')">carregar</button></li>
                <li><span>PS - IL    </span><button onclick="run('2024-02-05_ps-il')"    >carregar</button></li>
            </ul>
            <li>6 fev (3a)</li>
            <ul>
                <li><span>PCP - PAN </span><button onclick="run('2024-02-06_pcp-pan')" >carregar</button></li>
                <li><span>AD - BE   *</span><button onclick="run('2024-02-06_ad-be')"   >carregar</button></li>
                <li><span>IL - CHEGA *</span><button onclick="run('2024-02-06_il-chega')">carregar</button></li>
            </ul>
        </ul>

        <p>* - transcrição por rever</p>

        <div>
            <span id="time">0:00</span> / <span id="duration">0:00</span>
            <button id="toggle-play">⏯️</button><input id="progress" type="range" step="1" value="0">
        </div>
        
        <div id="content"></div>

        <script src="player.js"></script>
        <script>
            const timeEl = document.getElementById('time');
            const durationEl = document.getElementById('duration');
            const togglePlayEl = document.getElementById('toggle-play');
            const progressEl = document.getElementById('progress');
            const contentEl = document.getElementById('content');

            let subEls, audio, subtitles, currentSubIndex;
            currentSubIndex = -1;

            const highlightSub = (idx) => {
                subEls.forEach((subEl, i) => subEl.classList.toggle('highlight', i === idx));
                subEls[idx]?.scrollIntoView({ behavior: 'auto', block: 'center', inline: 'center' });
            }

            contentEl.addEventListener('click', (ev) => {
                const el = ev.target;
                const start = parseFloat(el.dataset.start);
                audio.currentTime = start;
                currentSubIndex = subEls.indexOf(el);
                highlightSub(currentSubIndex);
            });

            async function run(name) {
                if (audio) audio.pause();

                const p = (await player(name));
                ({ audio, subtitles } = p);

                contentEl.innerHTML = '';
                subEls = [];

                for (const { index, content, start, end } of subtitles) {
                    const divEl = document.createElement('div');
                    divEl.appendChild(document.createTextNode(content));
                    divEl.dataset.index = index;
                    divEl.dataset.start = start;
                    divEl.dataset.end = end;
                    contentEl.appendChild(divEl);
                    subEls.push(divEl);
                }

                const onDuration = () => {
                    const d = audio.duration;
                    durationEl.innerHTML = humanTime(d);
                    progressEl.max = Math.ceil(d);
                }

                if (audio.duration) onDuration();
                audio.addEventListener('loadedmetadata', onDuration);
                audio.addEventListener('timeupdate', () => {
                    const t = audio.currentTime;
                    const ti = Math.round(t);
                    const ts = humanTime(ti);
                    if (timeEl.innerHTML != ts) timeEl.innerHTML = ts;
                    if (ti != progressEl.value) progressEl.value = ti;

                    let sub = subtitles[currentSubIndex];
                    if (!sub || t < sub.start || t > sub.end) {
                        currentSubIndex = subtitles.findIndex((s, i) => s && t >= s.start && t <= s.end);
                        highlightSub(currentSubIndex);
                    }
                });

                progressEl.addEventListener('change', () => {
                    audio.currentTime = progressEl.value;
                });

                togglePlayEl.addEventListener('click', () => {
                    audio.paused ? audio.play() : audio.pause();
                });

                audio.play();
            }
        </script>
    </body>
</html>